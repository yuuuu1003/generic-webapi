<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŠ é€Ÿåº¦å ã„</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align:center; background:#f4f4f9; }
    .panel { border:1px solid #ddd; background:white; border-radius:10px; padding:20px; margin:10px auto; max-width:600px; }
    button { padding:10px 20px; font-size:16px; cursor:pointer; }
    #status { color: blue; font-weight: bold; margin: 10px; }
    #p5holder { width: 100%; height: 300px; background: #000; border-radius: 8px; }
    .tag { background: #eee; padding: 4px 8px; border-radius: 4px; margin: 2px; display: inline-block; }
  </style>
</head>
<body>
  <h1>ğŸ”® åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼å ã„</h1>
  <div class="panel">
    <button id="btnJoin">1. ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
    <button id="btnMeasure" disabled>2. è¨ˆæ¸¬ã—ã¦å ã†(10ç§’)</button>
    <div id="status">ã‚¹ãƒãƒ›ã‚’æº–å‚™ã—ã¦ãã ã•ã„</div>
    <div id="debug" style="font-size:10px; color:gray;"></div>
  </div>

  <div class="panel">
    <h2 id="rTitle">-</h2>
    <p id="rSummary">-</p>
    <div id="rTags"></div>
    <ul id="rAdvice" style="text-align:left;"></ul>
  </div>

  <div id="p5holder"></div>

   
  <img src="qr1.png" style="position: absolute; width: 350px; height:350px; top: 30px; right: 150px;">

  <script>
    const socket = io();
    const btnJoin = document.getElementById("btnJoin");
    const btnMeasure = document.getElementById("btnMeasure");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");

    let latest = null;

    socket.on("sensor", (data) => {
      latest = data;
      debugEl.textContent = `å—ä¿¡ä¸­: x=${data.g}, y=${data.b}, z=${data.z}`;
    });

    btnJoin.onclick = () => {
      socket.emit("join");
      btnJoin.disabled = true;
      btnMeasure.disabled = false;
      statusEl.textContent = "æ¥ç¶šå¾…æ©Ÿä¸­... ã‚¹ãƒãƒ›ã§ã€Œæ¥ç¶šã€ã‚’æŠ¼ã—ã¦å‹•ã‹ã—ã¦ãã ã•ã„";
    };

    btnMeasure.onclick = async () => {
      if (!latest) return alert("ã‚¹ãƒãƒ›ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ã¦ã„ã¾ã›ã‚“");
      btnMeasure.disabled = true;
      statusEl.textContent = "è¨ˆæ¸¬ä¸­... 10ç§’é–“ã‚¹ãƒãƒ›ã‚’å‹•ã‹ã—ã¦ãã ã•ã„ï¼";

      const features = await captureFeatures(10000);
      
      statusEl.textContent = "é‹å‹¢ã‚’è§£æä¸­...";
      const resp = await fetch("/api/oracle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ features })
      });
      const data = await resp.json();
      renderResult(data);
      statusEl.textContent = "å®Œäº†ï¼";
      btnMeasure.disabled = false;
    };

    async function captureFeatures(ms) {
      const samples = [];
      const start = Date.now();
      return new Promise(res => {
        const interval = setInterval(() => {
          if (latest) samples.push({ ...latest });
          if (Date.now() - start > ms) {
            clearInterval(interval);
            res({
              avgZ: samples.reduce((a, b) => a + Number(b.z), 0) / samples.length,
              count: samples.length,
              shake: samples.filter(s => Math.abs(s.g) > 30).length
            });
          }
        }, 100);
      });
    }

function renderResult(r) {
  if (!r) return;
  document.getElementById("rTitle").textContent = r.title || "å ã„ä¸å¯";
  document.getElementById("rSummary").textContent = r.summary || "è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  
  // ?. (ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒã‚§ã‚¤ãƒ‹ãƒ³ã‚°) ã¨ || [] ã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
  const tags = document.getElementById("rTags");
  tags.innerHTML = (r.tags || []).map(t => `<span class="tag">${t}</span>`).join("");
  
  const advice = document.getElementById("rAdvice");
  advice.innerHTML = (r.advice || []).map(a => `<li>${a}</li>`).join("");
  
  // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®šã‚’æ›´æ–°
      if(r.visual) {
        visual = { ...visual, ...r.visual }; 
        // ã‚‚ã—AIãŒè‰²ã‚’é€ã£ã¦ã“ãªã‹ã£ãŸæ™‚ã®ãŸã‚ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã‚’ç™½ã«ã—ã¦ãŠã
        if (!visual.color) visual.color = "#FFFFFF";
      }
}

    // p5.js Visualizer
    let visual = { shape: "sphere", rotationSpeed: 0.02, noiseAmount: 0.1 };
    new p5((p) => {
      p.setup = () => {
        let c = p.createCanvas(600, 300, p.WEBGL);
        c.parent("p5holder");
      };
      p.draw = () => {
        p.background(0); // èƒŒæ™¯ã¯é»’
        p.rotateX(p.frameCount * visual.rotationSpeed);
        p.rotateY(p.frameCount * visual.rotationSpeed);
        
        // AIãŒæŒ‡å®šã—ãŸè‰²ã‚’é©ç”¨ï¼
        p.stroke(visual.color || 255); 
        p.noFill();

        if (visual.shape === "box") p.box(100);
        else if (visual.shape === "torus") p.torus(70, 20);
        else if (visual.shape === "icosa") p.sphere(100, 4, 4); // ã‚«ã‚¯ã‚«ã‚¯ã—ãŸå½¢
        else p.sphere(100, 12, 12);

        // ç²’å­ã®è‰²ã‚‚å¤‰ãˆã‚‹ãªã‚‰ã“ã“
        p.fill(visual.color || 255);
        // ...ï¼ˆç²’å­ã‚’æç”»ã™ã‚‹ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹å ´åˆã¯ãã“ã‚‚ fill(visual.color) ã«ï¼‰
      };
    });
  </script>
</body>
</html>